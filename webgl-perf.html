<html>
	<head>
		<title>webgl-perf</title>
		<style>
canvas { 
float: right;
width: 80%; 
height: 80% 
}
div#text {
width:20%;
float: left;
}
</style>
	</head>
	<body>  
<link rel="stylesheet" 
href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/smoothness/jquery-ui.css" />	
<script src="http://rawgithub.com/mrdoob/three.js/master/build/three.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
		<script>
window.performance = window.performance || {};
performance.now = (function() {
    return performance.now       ||
        performance.mozNow    ||
        performance.msNow     ||
        performance.oNow      ||
        performance.webkitNow ||            
        Date.now 
})();
		
var run=true;		
var scene;
var objects;
var camera;
var renderer;
var distance=5;
var rpm=20;
var objectCount=1;
var renderCount;
var renderElapsedSum;
var fps;
var theoreticalFps;
var runStart;
var renderStart;
var renderEnd;
var requestID;
var sceneAdds;

function stop(){
	run=false;
	window.cancelAnimationFrame(requestID);
}		
function start(){
	if(run){
		stop();
	}
	if(!sceneAdds){
		sceneSelector();
	}
	run=true;
	runStart=performance.now();
	init();
}

function fixNumber(n,scale){
	return (parseInt(n.toString()/scale)).toFixed()*scale;
}
/** 
Show dynamic number so that it seems quite stable 
integer if possible
*/
function showDynamicNumber(n){
	var precision=0;
	if(n>10000){
	    return fixNumber(n,1000);
	}else if(n>1000){
	    return fixNumber(n,100);
	}else if(n>5){
		precision=0;
	}else if(n>0.5){
		precision=1;	   
	}else if(n>0.05){
		precision=2;	   
	}else{
		return n.toString();
	}
	return n.toFixed(precision);
}

function updateStats(){
	var renderElapsed=renderEnd-renderStart;
	var s="";
	renderElapsedSum+=renderElapsed;
	renderCount++;
	fps=1000*renderCount/(renderEnd-runStart);
    $( "#fps" ).text(showDynamicNumber(fps));
	s="Pending";
	if(renderElapsedSum>0){
		theoreticalFps=1000*renderCount/renderElapsedSum;
		s=showDynamicNumber(theoreticalFps);
	}
	$( "#theoreticalFps" ).text(s);
}

function render(timestamp) {
	if(!run){
		return;
	}
	renderStart=performance.now();
	var renderTime;
	if(timestamp){
		renderTime=timestamp;
	}else{
		renderTime=renderStart;
	}
	var rotation=rpm/60*Math.PI*(renderTime-runStart)/1000;
	requestID=requestAnimationFrame(render);
	objects.rotation.x = rotation;
	objects.rotation.y = rotation;	
	renderer.render(scene, camera);
	renderEnd=performance.now();
	setTimeout(function(){updateStats();},10);	
}

function sceneSelector(){
	sceneAdds=$("select.sceneSelector").val();
	start();
}

/**
*/
function getRandom(scale){
   if(!scale){
      scale=1;
   }
   return scale*Math.random();
}

function cubes(){
	for(var i=0;i<objectCount;i++){
	    var color = new THREE.Color();
	    var r=1;
		var g=getRandom(0.2);
		var b=getRandom(0.1);
		color.setRGB(r,g,b);
		var size=0.3*getRandom(0.7);
		var geometry = new THREE.CubeGeometry(size,size,size);
		var material = new THREE.MeshBasicMaterial( 
		{ 
		transparent: true,
		opacity: 0.2,
		depthWrite: false
		} );
		material.color=color;
		var cube = new THREE.Mesh( geometry, material );
	    cube.position.set(getRandom(),getRandom(),getRandom());
		objects.add( cube );
	}
}

function ambientLight(){
	var light = new THREE.AmbientLight( 0x404040 );
	scene.add( light );
}

function init(){
	scene = new THREE.Scene();
	objects = new THREE.Object3D();
	scene.add(objects);
	camera = new THREE.PerspectiveCamera
		( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
	renderer = new THREE.WebGLRenderer({canvas: canvasId});
	renderer.setSize( window.innerWidth, window.innerHeight );
	document.body.appendChild( renderer.domElement );
	camera.position.z = distance;
	for(var i=0;i<sceneAdds.length;i++){
	  var name=sceneAdds[i];
	  window[name]();
	}
	renderCount=0;
	renderElapsedSum=0;
	render();
}

$(function() {
    $( "#distance-slider" ).slider({
      min: 2.5,
      max: 10,
	  step: 0.1,
      value: distance,
      slide: function( event, ui ) {
        $( "#distance" ).val( ui.value );
		distance=parseFloat(ui.value);
		start();
      }
    });
    $( "#distance" ).val( $( "#distance-slider" ).slider( "value" ) );
    $( "#rpm-slider" ).slider({
      min: 1,
      max: 600,
	  step: 1,
      value: rpm,
      slide: function( event, ui ) {
        $( "#rpm" ).val( ui.value );
		rpm=parseFloat(ui.value);
		start();
      }
    });
    $( "#rpm" ).val( $( "#rpm-slider" ).slider( "value" ) );
    $( "#objectCount-slider" ).slider({
      min: 1,
      max: 1000,
	  step: 1,
      value: objectCount,
      slide: function( event, ui ) {
        $( "#objectCount" ).val( ui.value );
		objectCount=parseFloat(ui.value);
		start();
      }
    });
    $( "#objectCount" ).val( $( "#objectCount-slider" ).slider( "value" ) );
});

$( document ).ready(function() {
	$("select.sceneSelector").change(sceneSelector);
});
		</script>
<div id="text">		
<p>This tool is designed to be used with other tools</p> 
<ul>
<li><a href="http://www.techpowerup.com/gpuz/">GPU-Z</a>
for monitoring GPU load during execution
</li>
<li>Your ears to hear if fans make too much noise</li>
</ul>

<label for="distance">Distance:</label>
<input type="text" id="distance" style="border: 0;"/>
<div id="distance-slider" style="width: 80%;"></div>
<br/>
<label for="rpm">Revolutions Per Minute:</label>
<input type="text" id="rpm" style="border: 0;"/>
<div id="rpm-slider" style="width: 80%;"></div>
<br/>
actual FPS: <span id="fps"></span>
<br/>
theoretical FPS: <span id="theoreticalFps"></span>
<h3>Objects</h3>
<select class="sceneSelector" multiple="multiple">
  <option selected="true">cubes</option>
</select>
<br/>
<label for="count">Count:</label>
<input type="text" id="objectCount" style="border: 0;"/>
<div id="objectCount-slider" style="width: 80%;"></div>
<h3>Lights</h3>
<select class="sceneSelector" multiple="multiple">
  <option selected="true">ambientLight</option>
</select>
<button id="stop" onclick="stop()">Stop</button>	
<button id="start" onclick="start()">Start</button>
</div>	
<canvas id="canvasId"></canvas>	
	</body>
</html>